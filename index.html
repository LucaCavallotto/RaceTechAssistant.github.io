<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RaceTechAssistant</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0e0f13;      /* page */
      --bg-2:#171922;      /* panels */
      --bg-3:#1f2330;      /* tiles */
      --border:#2a2f3f;    /* borders */
      --text:#f3f7fb;      /* main text (BRIGHTER) */
      --muted:#c7cfde;     /* muted text (BRIGHTER) */
      --brand:#ff2a26;     /* accent */
      --ok:#9cf08a;
      --err:#ff9a9a;
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; min-height:100vh; display:flex; flex-direction:column;
      font:16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:radial-gradient(1000px 500px at 0% -10%, #151826 0%, transparent 60%),
                 radial-gradient(900px 600px at 110% 0%, #121522 0%, transparent 60%),
                 var(--bg-1);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit;text-decoration:none}

    /* Improve default Bootstrap contrasts inside dark panels */
    .card, .card * { color: inherit; }
    .text-muted, .text-body-secondary { color: var(--muted)!important; }

    /* Navbar */
    .navbar{background:rgba(15,17,24,.75)!important; backdrop-filter:saturate(140%) blur(8px)}
    .navbar.navbar-dark .navbar-toggler-icon{filter: invert(1) grayscale(100%)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand-dot{width:10px;height:10px;border-radius:999px;background:var(--brand)}
    .nav-link.btn{color:var(--muted)}
    .nav-link.btn.active, .nav-link.btn:focus{color:var(--text); background:linear-gradient(180deg,#1d2231,#121725); border-radius:999px}

    main{flex:1}

    .page-title{margin:.75rem 0 .25rem;font-size:clamp(22px,3vw,34px);letter-spacing:-.02em}
    .page-desc{margin:0 0 12px;color:var(--muted)}

    /* Cards */
    .card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h3{margin:0 0 12px;font-size:16px}

    /* Inputs */
    label{display:block;color:var(--muted);font-size:13px;margin:2px 0 6px}
    .input{display:flex;align-items:stretch;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#111420}
    .input input{
      flex:1;min-width:0;border:0;outline:0;background:transparent;color:var(--text);padding:10px 12px;font-size:14px
    }
    .input input::placeholder{color:#9aa3b2; opacity:1} /* brighter placeholder */
    .unit{display:flex;align-items:center;padding:0 10px;background:#141828;border-left:1px solid var(--border);color:var(--muted);font-size:12px}

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    button{border:1px solid var(--border);background:#22263a;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#ff4b45,#d92a26);border-color:#9e1917}
    button.secondary{background:#22263a}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* Result boxes + toasts */
    .result{
      margin-top:10px;border:1px solid var(--border);background:#111420;border-radius:12px;
      padding:12px;white-space:pre-wrap;min-height:44px;display:none;color:var(--text)
    }
    .ok{color:var(--ok);font-weight:600}
    .err{color:var(--err);font-weight:600}

    /* Mode toggle */
    .mode-toggle{display:inline-flex;border:1px solid var(--border);background:#101420;border-radius:999px;overflow:hidden}
    .mode-toggle button{padding:8px 12px;border:0;background:transparent;color:var(--muted);cursor:pointer}
    .mode-toggle button[aria-pressed="true"]{background:#1b2030;color:var(--text)}

    /* Big highlight tile for start fuel */
    .big-callout{display:none;margin-top:12px;padding:16px;border-radius:14px;border:1px solid #9e1917;background:linear-gradient(180deg,rgba(255,75,69,.15),rgba(217,42,38,.08));box-shadow:var(--shadow);text-align:center;color:var(--text)}
    .big-callout h4{margin:0 0 6px;font-size:18px;letter-spacing:.02em}
    .big-callout .liters{font-size:28px;font-weight:800;letter-spacing:.02em}

    /* Highlighted style for pressure tyre cards (same as fuel callout) */
    .tyre-highlight{
      border:1px solid #9e1917 !important;
      background:linear-gradient(180deg,rgba(255,75,69,.15),rgba(217,42,38,.08)) !important;
      box-shadow:var(--shadow);
    }

    /* Tyre layout grid (FR | FL / RL | RR => FL is top-right) */
    .tyre-grid{display:grid;gap:12px;grid-template-columns:1fr 1fr;grid-template-areas:'fr fl' 'rl rr';align-items:start}
    .tyre-fl{grid-area:fl}
    .tyre-fr{grid-area:fr}
    .tyre-rl{grid-area:rl}
    .tyre-rr{grid-area:rr}

    /* NEW: uniform stats grids for results */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:12px;
    }
    .stat-card{
      background:var(--bg-3);
      border:1px solid var(--border);
      border-radius:12px;
      text-align:center;
      padding:10px;
    }
    .stat-card strong{font-size:18px}

    /* Small helper for inline unit text (kept bright) */
    .unit-inline{color:var(--text)}

    footer{border-top:1px solid var(--border);background:#0d0f15;color:var(--muted)}
    /* Più spazio tra le box */
    .tyre-grid{gap:16px}              /* era 12px */
    .stats-grid{gap:16px}             /* era 12px */
    .stat-card{padding:14px}          /* era 10px */

    /* Wrapper: griglia "2x2 a sinistra + colonna a destra" */
    .panel-stats-wrap{
      display:grid;
      grid-template-columns: 1fr 260px; /* sinistra 2x2, destra colonna fissa */
      gap:16px;
      align-items:start;
    }
    @media (max-width: 768px){
      .panel-stats-wrap{
        grid-template-columns: 1fr;    /* stack su mobile */
      }
    }

    /* Colonna destra: stack verticale delle card */
    .side-stats{
      display:grid;
      grid-auto-rows:minmax(82px,auto);
      gap:16px;
    }

    /* Manteniamo il 2x2 per le gomme (FL top-right come da tua UI) */
    .tyre-grid{
      grid-template-columns: repeat(2, 1fr);
      grid-template-areas:'fr fl' 'rl rr';
    }
    /* Spacing & grid for results: 2 rows × 4 cols (collapses on small screens) */
    .results-row{
      display:grid;
      grid-template-columns: repeat(4, minmax(150px,1fr));
      gap:18px;                           /* a bit more spacing */
      align-items:stretch;
    }
    @media (max-width: 992px){
      .results-row{ grid-template-columns: repeat(2, minmax(150px,1fr)); }
    }

    /* Emphasis for tyre cards (more visible than others) */
    .tyre-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid #3a4258;          /* brighter border */
      box-shadow: 0 10px 30px rgba(0,0,0,.28), 0 0 0 1px rgba(255,255,255,.04) inset;
    }
    .tyre-card strong{ font-size:20px }   /* slightly larger number */

    /* Summary cards keep a calmer style */
    .summary-card{
      background: var(--bg-2);
      border: 1px solid var(--border);
    }
    /* Più spazio tra le box */
    .tyre-grid{ gap:16px; }      /* prima 12px */
    .stat-card{ padding:14px; }  /* prima 10px */

    /* Layout risultati: sinistra 2x2 gomme, destra colonna riassunti */
    .panel-stats-wrap{
      display:grid;
      grid-template-columns: 1fr 280px; /* sinistra elastica, destra fissa */
      gap:18px;
      align-items:start;
    }
    @media (max-width: 992px){
      .panel-stats-wrap{
        grid-template-columns: 1fr;      /* stack su tablet/mobile */
      }
    }

    /* Colonna destra: cards in pila */
    .side-stats{
      display:grid;
      grid-auto-rows:minmax(84px,auto);
      gap:16px;
    }

    /* Gomme più “visibili” delle altre card */
    .tyre-card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.025));
      border: 1px solid #3a4258;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .tyre-card strong{ font-size:20px; }
    /* Better phone layout: one column on very small screens */
    @media (max-width: 576px){
      .stats-grid{ grid-template-columns: 1fr; }
    }

    /* Optional: make tyre highlights consistent height on mobile */
    @media (max-width: 576px){
      .stat-card{ min-height: 82px; }
    }
    /* Phone layout: each results row becomes a single column */
    @media (max-width: 576px){
      #temp-tyre-grid,
      #temp-stats,
      #brake-tyre-grid,
      #brake-summary{
        grid-template-columns: 1fr !important;  /* force 1 column */
        gap: 14px;                               /* comfy spacing */
      }
    }

  </style>
</head>
<body class="d-flex flex-column" >
  <!-- Navbar with selector; expands on md+, collapses into hamburger on smaller -->
  <nav class="navbar navbar-dark navbar-expand-md sticky-top border-bottom" aria-label="Primary">
    <div class="container">
      <a class="navbar-brand mx-md-0 mx-auto" href="#">
        <span class="brand"><span class="brand-dot"></span><span>RaceTechAssistant</span></span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#primaryNav" aria-controls="primaryNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-md-end" id="primaryNav">
        <ul class="navbar-nav ms-md-3 gap-1">
          <li class="nav-item"><button id="tab-fuel" class="nav-link btn px-3 py-2 active" role="tab" aria-selected="true" aria-controls="panel-fuel">Fuel</button></li>
          <li class="nav-item"><button id="tab-temp" class="nav-link btn px-3 py-2" role="tab" aria-selected="false" aria-controls="panel-temp">Pressures</button></li>
          <li class="nav-item"><button id="tab-brake" class="nav-link btn px-3 py-2" role="tab" aria-selected="false" aria-controls="panel-brake">Brake Ducts</button></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="flex-grow-1 py-3">
    <div class="container">
      <h1 id="pageTitle" class="page-title">Fuel Calculator</h1>
      <p id="pageDesc" class="page-desc">Enter race time and lap pace (or fixed laps), then Calculate. Use Pro for tank size, formation/cool-down laps, and mandatory pitstops.</p>

      <!-- Panels -->
      <div class="row g-3">
        <div class="col-12">
          <article id="panel-fuel" role="tabpanel" aria-labelledby="tab-fuel" class="card h-100" tabindex="0">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
                <h3 class="m-0">Fuel</h3>
                <div class="mode-toggle" role="group" aria-label="Mode">
                  <button id="mode-normal" aria-pressed="true">Normal</button>
                  <button id="mode-pro" aria-pressed="false">Pro</button>
                </div>
              </div>

              <!-- NORMAL FORM -->
              <div id="fuel-form-normal" aria-hidden="false">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label>Total race time</label>
                    <div class="row g-2">
                      <div class="col-6"><div class="input w-100"><input id="raceH" type="number" min="0" placeholder="01"><span class="unit">hrs</span></div></div>
                      <div class="col-6"><div class="input w-100"><input id="raceM" type="number" min="0" placeholder="30"><span class="unit">mins</span></div></div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label>Average lap time</label>
                    <div class="row g-2">
                      <div class="col-6"><div class="input w-100"><input id="lapM" type="number" min="0" placeholder="01"><span class="unit">mins</span></div></div>
                      <div class="col-6"><div class="input w-100"><input id="lapS" type="number" min="0" step="0.1" placeholder="40.5"><span class="unit">secs</span></div></div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6"><label>Fuel per lap</label><div class="input w-100"><input id="fuelLap" type="number" min="0" step="0.01" placeholder="2.45"><span class="unit" data-u="volume">L</span></div></div>
                  <div class="col-12 col-md-6"><label>Fixed total laps (optional)</label><div class="input w-100"><input id="lapsFixed" type="number" min="0" placeholder="0"><span class="unit">laps</span></div></div>
                </div>
              </div>

              <!-- PRO FORM -->
              <div id="fuel-form-pro" aria-hidden="true" style="display:none">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label>Total race time</label>
                    <div class="row g-2">
                      <div class="col-6"><div class="input w-100"><input id="raceH_p" type="number" min="0" placeholder="01"><span class="unit">hrs</span></div></div>
                      <div class="col-6"><div class="input w-100"><input id="raceM_p" type="number" min="0" placeholder="30"><span class="unit">mins</span></div></div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label>Average lap time</label>
                    <div class="row g-2">
                      <div class="col-6"><div class="input w-100"><input id="lapM_p" type="number" min="0" placeholder="01"><span class="unit">mins</span></div></div>
                      <div class="col-6"><div class="input w-100"><input id="lapS_p" type="number" min="0" step="0.1" placeholder="40.5"><span class="unit">secs</span></div></div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6"><label>Fuel per lap</label><div class="input w-100"><input id="fuelLap_p" type="number" min="0" step="0.01" placeholder="2.45"><span class="unit" data-u="volume">L</span></div></div>
                  <div class="col-12 col-md-6"><label>Tank capacity</label><div class="input w-100"><input id="tank_p" type="number" min="0" placeholder="120"><span class="unit" data-u="volume">L</span></div></div>
                  <div class="col-12 col-md-6"><label>Fixed total laps (optional)</label><div class="input w-100"><input id="lapsFixed_p" type="number" min="0" placeholder="0"><span class="unit">laps</span></div></div>
                  <div class="col-12 col-md-6"><label>Mandatory pitstops</label><div class="input w-100"><input id="mandStops" type="number" min="0" step="1" placeholder="0"><span class="unit">stops</span></div></div>
                  <div class="col-12 col-md-6"><label><input id="includeFormation" type="checkbox" checked style="margin-right:8px">Include formation lap</label></div>
                  <div class="col-12 col-md-6"><label><input id="includeCooldown" type="checkbox" checked style="margin-right:8px">Include cool-down lap</label></div>
                </div>
              </div>

              <div class="mt-3 btns">
                <button class="primary" id="btnFuel">Calculate fuel</button>
                <button class="secondary" id="btnFuelReset">Reset</button>
              </div>

              <!-- BIG callout: Start fuel -->
              <div id="fuel-callout" class="big-callout" aria-live="polite">
                <h4>Put in the tank</h4>
                <div class="liters"><span id="start-fuel">0.0</span> <span data-u="volume">L</span></div>
              </div>

              <!-- RESULTS in uniform grids -->
              <div id="fuel-stats1" class="stats-grid mt-2" role="group" aria-label="Fuel summary" style="display:none">
                <div class="stat-card"><strong id="stat-pits">0</strong><div class="text-uppercase small" style="color:var(--muted)">Pitstops (calc)</div></div>
                <div class="stat-card"><strong><span id="stat-laps">0</span> <span class="unit-inline">laps</span></strong><div class="text-uppercase small" style="color:var(--muted)">Total</div></div>
                <div class="stat-card"><strong><span id="stat-stintlaps">0</span> <span class="unit-inline">laps</span></strong><div class="text-uppercase small" style="color:var(--muted)">Per Stint</div></div>
                <div class="stat-card"><strong><span id="stat-finallaps">0</span> <span class="unit-inline">laps</span></strong><div class="text-uppercase small" style="color:var(--muted)">Final Stint</div></div>
              </div>
              <div id="fuel-stats2" class="stats-grid mt-1" role="group" aria-label="Fuel litres" style="display:none">
                <div class="stat-card"><strong><span id="stat-fuel-total">0</span> <span class="unit-inline" data-u="volume">L</span></strong><div class="text-uppercase small" style="color:var(--muted)">Total (adj.)</div></div>
                <div class="stat-card"><strong><span id="stat-fuel-stint">0</span> <span class="unit-inline" data-u="volume">L</span></strong><div class="text-uppercase small" style="color:var(--muted)">Per Stint</div></div>
                <div class="stat-card"><strong><span id="stat-fuel-final">0</span> <span class="unit-inline" data-u="volume">L</span></strong><div class="text-uppercase small" style="color:var(--muted)">Final Stint</div></div>
                <div class="stat-card"><strong><span id="stat-buffer">1</span> <span class="unit-inline" data-u="volume">L</span></strong><div class="text-uppercase small" style="color:var(--muted)">Suggested Buffer</div></div>
              </div>
              <div class="btns" id="fuel-copy-wrap" style="display:none">
                <button class="secondary" id="btnFuelCopy">Copy summary</button>
                <span id="copyToast" class="ok" style="display:none">Copied!</span>
              </div>
              <div id="outFuel" class="result" role="status" aria-live="polite"></div>
            </div>
          </article>
        </div>

        <!-- Pressure (temperature) -->
        <div class="col-12">
          <article id="panel-temp" role="tabpanel" aria-labelledby="tab-temp" class="card h-100" hidden tabindex="0">
            <div class="card-body">
              <h3>Tyre Pressure from Ambient Temperature</h3>
              <div class="tyre-grid" aria-label="Tyre pressures in car layout">
                <div class="tyre-fr">
                  <label>FR (<span data-u="pressure">psi</span>)</label>
                  <div class="input w-100"><input id="pFR" type="number" min="0" step="0.01" placeholder="25.8"></div>
                </div>
                <div class="tyre-fl">
                  <label>FL (<span data-u="pressure">psi</span>)</label>
                  <div class="input w-100"><input id="pFL" type="number" min="0" step="0.01" placeholder="25.8"></div>
                </div>
                <div class="tyre-rl">
                  <label>RL (<span data-u="pressure">psi</span>)</label>
                  <div class="input w-100"><input id="pRL" type="number" min="0" step="0.01" placeholder="25.2"></div>
                </div>
                <div class="tyre-rr">
                  <label>RR (<span data-u="pressure">psi</span>)</label>
                  <div class="input w-100"><input id="pRR" type="number" min="0" step="0.01" placeholder="25.2"></div>
                </div>
              </div>
              <div class="car-hint" style="color:var(--muted)">Top row is front axle (FR | FL), bottom row is rear axle (RL | RR). FL is <strong>top-right</strong> as requested.</div>

              <div class="row g-3 mt-2">
                <div class="col-12 col-md-6"><label>Ambient before</label><div class="input w-100"><input id="tBefore" type="number" step="0.1" placeholder="20"><span class="unit" data-u="temp">°C</span></div></div>
                <div class="col-12 col-md-6"><label>Ambient after</label><div class="input w-100"><input id="tAfter" type="number" step="0.1" placeholder="28"><span class="unit" data-u="temp">°C</span></div></div>
                <div class="col-12 col-md-6"><label>Target min (optional)</label><div class="input w-100"><input id="targetMin" type="number" step="0.01" placeholder="26.0"><span class="unit" data-u="pressure">psi</span></div></div>
                <div class="col-12 col-md-6"><label>Target max (optional)</label><div class="input w-100"><input id="targetMax" type="number" step="0.01" placeholder="27.4"><span class="unit" data-u="pressure">psi</span></div></div>
              </div>
              <div class="btns">
                <button class="primary" id="btnTemp">Calculate pressures</button>
                <button class="secondary" id="btnTempReset">Reset</button>
              </div>

              <!-- Results -->
              <div id="temp-tyre-grid" class="stats-grid mt-2" role="group" aria-label="Tyre pressures" style="display:none">
                <div class="stat-card tyre-highlight"><strong><span id="tp-fl">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong><div class="text-uppercase small" style="color:var(--muted)">FL</div></div>
                <div class="stat-card tyre-highlight"><strong><span id="tp-fr">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong><div class="text-uppercase small" style="color:var(--muted)">FR</div></div>
                <div class="stat-card"><strong><span id="t-delta">0</span> <span class="unit-inline" data-u="temp">°C</span></strong><div class="text-uppercase small" style="color:var(--muted)">Δ Temperature</div></div>
                <div class="stat-card"><strong><span id="p-delta">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong><div class="text-uppercase small" style="color:var(--muted)">Δ Pressure / tyre</div></div>
              </div>

              <div id="temp-stats" class="stats-grid mt-1" role="group" aria-label="Pressure summary" style="display:none">
                <div class="stat-card tyre-highlight"><strong><span id="tp-rl">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong><div class="text-uppercase small" style="color:var(--muted)">RL</div></div>
                <div class="stat-card tyre-highlight"><strong><span id="tp-rr">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong><div class="text-uppercase small" style="color:var(--muted)">RR</div></div>
                <div class="stat-card"><strong><span id="target-range">–</span></strong><div class="text-uppercase small" style="color:var(--muted)">Target Window</div></div>
                <div class="stat-card"><strong><span id="press-ok">–</span></strong><div class="text-uppercase small" style="color:var(--muted)">Status</div></div>
              </div>
              <div id="outTemp" class="result" role="status" aria-live="polite"></div>
            </div>
          </article>
        </div>

        <!-- Brake ducts -->
        <div class="col-12">
          <article id="panel-brake" role="tabpanel" aria-labelledby="tab-brake" class="card h-100" hidden tabindex="0">
            <div class="card-body">
              <h3>Tyre Pressure from Brake Duct Settings</h3>

              <div class="tyre-grid" aria-label="Brake duct pressures in car layout">
                <div class="tyre-fr">
                  <label>FR (<span data-u="pressure">psi</span>)</label>
                  <div class="input w-100"><input id="bFR" type="number" min="0" step="0.01" placeholder="25.8"></div>
                </div>
                <div class="tyre-fl">
                  <label>FL (<span data-u="pressure">psi</span>)</label>
                  <div class="input w-100"><input id="bFL" type="number" min="0" step="0.01" placeholder="25.8"></div>
                </div>
                <div class="tyre-rl">
                  <label>RL (<span data-u="pressure">psi</span>)</label>
                  <div class="input w-100"><input id="bRL" type="number" min="0" step="0.01" placeholder="25.2"></div>
                </div>
                <div class="tyre-rr">
                  <label>RR (<span data-u="pressure">psi</span>)</label>
                  <div class="input w-100"><input id="bRR" type="number" min="0" step="0.01" placeholder="25.2"></div>
                </div>
              </div>
              <div class="car-hint" style="color:var(--muted)">Top row is front axle (FR | FL), bottom row is rear axle (RL | RR). FL is <strong>top-right</strong>.</div>

              <div class="row g-3 mt-2">
                <div class="col-12 col-md-6"><label>Brake ducts before</label><div class="input w-100"><input id="bdBefore" type="number" step="1" placeholder="3"></div></div>
                <div class="col-12 col-md-6"><label>Brake ducts after</label><div class="input w-100"><input id="bdAfter" type="number" step="1" placeholder="2"></div></div>
              </div>
              <div class="btns">
                <button class="primary" id="btnBrake">Calculate pressures</button>
                <button class="secondary" id="btnBrakeReset">Reset</button>
              </div>
              
              <!-- Results (Brake Ducts) -->
              <!-- Results (Brake Ducts) -->
              <!-- Tyres FIRST -->
              <div id="brake-tyre-grid" class="stats-grid mt-2" role="group" aria-label="Tyre pressures (brake)" style="display:none">
                <div class="stat-card tyre-highlight">
                  <strong><span id="bd-fr">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong>
                  <div class="text-uppercase small" style="color:var(--muted)">FR</div>
                </div>
                <div class="stat-card tyre-highlight">
                  <strong><span id="bd-fl">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong>
                  <div class="text-uppercase small" style="color:var(--muted)">FL</div>
                </div>
                <div class="stat-card tyre-highlight">
                  <strong><span id="bd-rl">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong>
                  <div class="text-uppercase small" style="color:var(--muted)">RL</div>
                </div>
                <div class="stat-card tyre-highlight">
                  <strong><span id="bd-rr">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong>
                  <div class="text-uppercase small" style="color:var(--muted)">RR</div>
                </div>
              </div>

              <!-- Summary SECOND -->
              <div id="brake-summary" class="stats-grid mt-1" role="group" aria-label="Brake-duct summary" style="display:none">
                <div class="stat-card">
                  <strong id="bd-delta">0</strong>
                  <div class="text-uppercase small" style="color:var(--muted)">Δ Setting</div>
                </div>
                <div class="stat-card">
                  <strong><span id="bd-pdelta">0.00</span> <span class="unit-inline" data-u="pressure">psi</span></strong>
                  <div class="text-uppercase small" style="color:var(--muted)">Δ Pressure / tyre</div>
                </div>
                <div class="stat-card">
                  <strong><span id="bd-status">–</span></strong>
                  <div class="text-uppercase small" style="color:var(--muted)">Status</div>
                </div>
                <div class="stat-card">
                  <strong><span id="bd-note">1×</span></strong>
                  <div class="text-uppercase small" style="color:var(--muted)">Applied to all tyres</div>
                </div>
              </div>

              <div id="outBrake" class="result" role="status" aria-live="polite"></div>
            </div>
          </article>
        </div>
      </div>
    </div>
  </main>

  <footer class="mt-auto py-3">
    <div class="container text-center small" style="color:var(--muted)">© 2025 RaceTechAssistant • All calculations are best-effort estimates.</div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let units = 'metric'; // fixed

    // Utilities
    const round = (x,d=2)=>Number.isFinite(x)?Math.round(x*10**d)/10**d:NaN;
    const num = id => parseFloat(document.getElementById(id).value);
    const val = id => document.getElementById(id).value;

    const showGrid = id => document.getElementById(id).style.display='grid';
    const hide = id => document.getElementById(id).style.display='none';
    const showBlock = id => document.getElementById(id).style.display='block';
    const showResult=(id,html)=>{const el=document.getElementById(id); el.style.display='block'; el.innerHTML=html};
    const hideResult=id=>{const el=document.getElementById(id); el.style.display='none'; el.innerHTML=''};

    let lastFuelSummary = '';

    async function copyText(text){
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
        }else{
          const ta=document.createElement('textarea');
          ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
        const toast=document.getElementById('copyToast'); if(toast){toast.style.display='inline'; setTimeout(()=>toast.style.display='none',1500);} 
      }catch(e){ alert('Copy failed'); }
    }

    // ------- Header title/desc per tab -------
    const pageTitle = document.getElementById('pageTitle');
    const pageDesc  = document.getElementById('pageDesc');
    function setHeaderFor(tab){
      if(tab==='tab-fuel'){
        pageTitle.textContent = 'Fuel Calculator';
        pageDesc.textContent  = 'Enter race time and lap pace (or fixed laps), then Calculate. Use Pro for tank size, formation/cool-down laps, and mandatory pitstops.';
      } else if(tab==='tab-temp'){
        pageTitle.textContent = 'Tyre Pressures — Temperature Change';
        pageDesc.textContent  = 'Input current cold pressures and ambient before/after. We apply 0.1 psi per °C and preview corrected pressures vs target window.';
      } else if(tab==='tab-brake'){
        pageTitle.textContent = 'Tyre Pressures — Brake Duct Change';
        pageDesc.textContent  = 'Enter current pressures and brake-duct settings before/after. We apply 0.2 psi per step to estimate new pressures.';
      }
    }

    // ------- Tabs logic via navbar buttons -------
    const tabs = [
      {btn:'tab-fuel', panel:'panel-fuel'},
      {btn:'tab-temp', panel:'panel-temp'},
      {btn:'tab-brake', panel:'panel-brake'}
    ];

    function activateTab(key){
      tabs.forEach(t=>{
        const btn = document.getElementById(t.btn);
        const panel = document.getElementById(t.panel);
        const isActive = t.btn===key;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', String(isActive));
        panel.hidden = !isActive;
        if(isActive){ panel.focus({preventScroll:true}); }
      });
      setHeaderFor(key);
    }

    tabs.forEach(t=>{ document.getElementById(t.btn).addEventListener('click', ()=>activateTab(t.btn)); });

    // Init header labels
    setHeaderFor('tab-fuel');

    // ------- Fuel: mode toggle -------
    const normalBtn = document.getElementById('mode-normal');
    const proBtn = document.getElementById('mode-pro');
    const normalForm = document.getElementById('fuel-form-normal');
    const proForm = document.getElementById('fuel-form-pro');

    function setMode(mode){
      const isPro = mode==='pro';
      normalBtn.setAttribute('aria-pressed', String(!isPro));
      proBtn.setAttribute('aria-pressed', String(isPro));
      normalForm.style.display = isPro? 'none' : '';
      normalForm.setAttribute('aria-hidden', String(isPro));
      proForm.style.display = isPro? '' : 'none';
      proForm.setAttribute('aria-hidden', String(!isPro));
    }
    normalBtn.addEventListener('click', ()=>setMode('normal'));
    proBtn.addEventListener('click', ()=>setMode('pro'));

    // ------- Fuel calc (both modes) -------
    function readFuelInputs(){
      const isPro = proBtn.getAttribute('aria-pressed')==='true';
      const read = (id, def=0)=>{ const v = parseFloat(val(id)); return isNaN(v)? def : v; };
      if(!isPro){
        return {
          raceH: read('raceH'), raceM: read('raceM'), lapM: read('lapM'), lapS: read('lapS'),
          fuelLap: num('fuelLap'), fixedLaps: read('lapsFixed'),
          tank: 0, includeFormation: true, includeCooldown: true, mandStops: 0
        };
      } else {
        return {
          raceH: read('raceH_p'), raceM: read('raceM_p'), lapM: read('lapM_p'), lapS: read('lapS_p'),
          fuelLap: num('fuelLap_p'), fixedLaps: read('lapsFixed_p'), tank: num('tank_p'),
          includeFormation: document.getElementById('includeFormation').checked,
          includeCooldown: document.getElementById('includeCooldown').checked,
          mandStops: parseInt(val('mandStops'))||0
        };
      }
    }

    function fuelDisplay(liters){ return round(liters,2); }

    function calcFuel(){
      const inp = readFuelInputs();

      if (Number.isNaN(inp.fuelLap) || inp.fuelLap <= 0){
        hide('fuel-stats1'); hide('fuel-stats2'); hide('fuel-callout');
        showResult('outFuel','❌ <span class="err">Please enter a valid fuel per lap.</span>');
        document.getElementById('fuel-copy-wrap').style.display='none';
        return;
      }

      const fuelLapL = inp.fuelLap; // metric only
      const tankL    = inp.tank;

      const raceSeconds = (inp.raceH*3600) + (inp.raceM*60);
      const lapSeconds  = (inp.lapM*60) + inp.lapS;

      let raceLaps;
      if (inp.fixedLaps>0){ raceLaps = inp.fixedLaps; }
      else if (raceSeconds>0 && lapSeconds>0){ raceLaps = Math.ceil(raceSeconds / lapSeconds); }
      else {
        hide('fuel-stats1'); hide('fuel-stats2'); hide('fuel-callout');
        showResult('outFuel','❌ <span class="err">Provide either total race time and lap time, or a fixed total lap count.</span>');
        document.getElementById('fuel-copy-wrap').style.display='none';
        return;
      }

      // Optional laps
      let totalLaps = raceLaps; if (inp.includeFormation) totalLaps += 1; if (inp.includeCooldown)  totalLaps += 1;

      // Base total fuel (liters)
      let totalFuelL = totalLaps * fuelLapL;

      // Mandatory stops: pit-in lap ~90% consumption
      const PIT_LAP_FACTOR = 0.9; if (inp.mandStops>0){ totalFuelL -= inp.mandStops * (1 - PIT_LAP_FACTOR) * fuelLapL; }

      // Stints if tank known
      let pits=0, stintLaps=0, finalLaps=0, stintFuelL=0, finalFuelL=round(totalFuelL,2);
      let startFuelL = round(totalFuelL,2);
      if (tankL>0 && fuelLapL>0){
        stintLaps = Math.floor(tankL / fuelLapL);
        pits = Math.floor(totalLaps / Math.max(stintLaps,1));
        finalLaps = Math.max(totalLaps - (stintLaps * pits), 0);
        stintFuelL = round(stintLaps * fuelLapL,2);
        finalFuelL = round(finalLaps * fuelLapL,2);
        startFuelL = round(Math.min(stintFuelL||totalFuelL, totalFuelL),2);
      }

      // Update tiles
      document.getElementById('stat-pits').textContent = pits;
      document.getElementById('stat-laps').textContent = totalLaps;
      document.getElementById('stat-stintlaps').textContent = stintLaps;
      document.getElementById('stat-finallaps').textContent = finalLaps;
      document.getElementById('stat-fuel-total').textContent = fuelDisplay(totalFuelL);
      document.getElementById('stat-fuel-stint').textContent = fuelDisplay(stintFuelL);
      document.getElementById('stat-fuel-final').textContent = fuelDisplay(finalFuelL);
      document.getElementById('stat-buffer').textContent = fuelDisplay(1);

      // Big callout
      document.getElementById('start-fuel').textContent = fuelDisplay(startFuelL).toFixed(1);
      showBlock('fuel-callout');

      // Reveal stats and enable copy
      hideResult('outFuel'); showGrid('fuel-stats1'); showGrid('fuel-stats2');
      lastFuelSummary = `✅ Done.
Estimated laps: ${totalLaps} (base: ${raceLaps}${inp.includeFormation?" + formation":""}${inp.includeCooldown?" + cool-down":""})
Total fuel (adj.): ${fuelDisplay(totalFuelL)} L
Start fuel: ${fuelDisplay(startFuelL)} L`;
      document.getElementById('fuel-copy-wrap').style.display='flex';
    }
    document.getElementById('btnFuel').addEventListener('click', calcFuel);
    document.getElementById('btnFuelReset').addEventListener('click', ()=>{
      ['raceH','raceM','lapM','lapS','fuelLap','lapsFixed','raceH_p','raceM_p','lapM_p','lapS_p','fuelLap_p','tank_p','lapsFixed_p','mandStops'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
      const f=document.getElementById('includeFormation'); if(f) f.checked=true;
      const c=document.getElementById('includeCooldown'); if(c) c.checked=true;
      ['stat-pits','stat-laps','stat-stintlaps','stat-finallaps','stat-fuel-total','stat-fuel-stint','stat-fuel-final','stat-buffer','start-fuel'].forEach(id=>document.getElementById(id).textContent='0');
      hide('fuel-stats1'); hide('fuel-stats2'); hide('fuel-callout'); hideResult('outFuel');
      document.getElementById('fuel-copy-wrap').style.display='none'; lastFuelSummary='';
    });
    document.getElementById('btnFuelCopy').addEventListener('click', ()=> copyText(lastFuelSummary));

    // ------- Temp → Pressure -------
    function calcTemp(){
      const pFR = num('pFR'); const pFL = num('pFL'); const pRL = num('pRL'); const pRR = num('pRR');
      const tBefore = num('tBefore'); const tAfter  = num('tAfter');
      const tMin = num('targetMin'); const tMax = num('targetMax');

      if ([pFR,pFL,pRL,pRR,tBefore,tAfter].some(v=>Number.isNaN(v))){ hide('temp-stats'); hide('temp-tyre-grid'); showResult('outTemp','❌ <span class="err">Please fill in all fields (targets optional).</span>'); return; }

      const dT = tAfter - tBefore; // °C
      const dP = 0.1 * dT; // psi per °C
      const corrected = [pFL, pFR, pRL, pRR].map(v=>round(v + dP,2)); // FL,FR,RL,RR in psi

      // Per-tyre grid
      document.getElementById('tp-fl').textContent = corrected[0];
      document.getElementById('tp-fr').textContent = corrected[1];
      document.getElementById('tp-rl').textContent = corrected[2];
      document.getElementById('tp-rr').textContent = corrected[3];

      // Summary tiles
      document.getElementById('t-delta').textContent = round(dT,1);
      document.getElementById('p-delta').textContent = round(dP,2);
      document.getElementById('target-range').textContent = (!Number.isNaN(tMin) && !Number.isNaN(tMax))? `${tMin}–${tMax} psi` : '—';

      let status = '—'; if (!Number.isNaN(tMin) && !Number.isNaN(tMax)){ const allOk = corrected.every(v=>v>=tMin && v<=tMax); status = allOk? 'Within window' : 'Adjust needed'; }
      document.getElementById('press-ok').textContent = status;

      hideResult('outTemp'); showGrid('temp-stats'); showGrid('temp-tyre-grid');
    }
    document.getElementById('btnTemp').addEventListener('click', calcTemp);
    document.getElementById('btnTempReset').addEventListener('click', ()=>{
      ['pFL','pFR','pRL','pRR','tBefore','tAfter','targetMin','targetMax'].forEach(id=>document.getElementById(id).value='');
      ['t-delta','p-delta','target-range','press-ok'].forEach(id=>document.getElementById(id).textContent='0');
      document.getElementById('press-ok').textContent='—'; document.getElementById('target-range').textContent='—';
      hide('temp-stats'); hide('temp-tyre-grid'); hideResult('outTemp');
    });

    // ------- Brake ducts → Pressure -------
    function calcBrake(){
      const pFL = num('bFL'); const pFR = num('bFR'); const pRL = num('bRL'); const pRR = num('bRR');
      const bdBefore = num('bdBefore'); const bdAfter  = num('bdAfter');

      if ([pFL,pFR,pRL,pRR,bdBefore,bdAfter].some(v=>Number.isNaN(v))){ hide('brake-summary'); hide('brake-tyre-grid'); showResult('outBrake','❌ <span class=\"err\">Please fill in all fields.</span>'); return; }

      const dBD = bdAfter - bdBefore; const dP = 0.2 * dBD;

      document.getElementById('bd-delta').textContent = dBD;
      document.getElementById('bd-pdelta').textContent = round(dP,2);
      document.getElementById('bd-status').textContent = dBD===0? 'No change' : (dBD>0? 'More open' : 'More closed');
      document.getElementById('bd-note').textContent = '1×';

      const corrected = [pFR, pFL, pRL, pRR].map(v=>round(v + dP,2));
      document.getElementById('bd-fr').textContent = corrected[0];
      document.getElementById('bd-fl').textContent = corrected[1];
      document.getElementById('bd-rl').textContent = corrected[2];
      document.getElementById('bd-rr').textContent = corrected[3];

      hideResult('outBrake'); showGrid('brake-summary'); showGrid('brake-tyre-grid');
    }
    document.getElementById('btnBrake').addEventListener('click', calcBrake);
    document.getElementById('btnBrakeReset').addEventListener('click', ()=>{
      ['bFL','bFR','bRL','bRR','bdBefore','bdAfter'].forEach(id=>document.getElementById(id).value='');
      ['bd-delta','bd-pdelta','bd-status','bd-note'].forEach(id=>document.getElementById(id).textContent='0');
      document.getElementById('bd-status').textContent='—'; hide('brake-summary'); hide('brake-tyre-grid'); hideResult('outBrake');
    });
  </script>
</body>
</html>
